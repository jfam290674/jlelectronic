{# billing/templates/billing/debit_note_ride.html #}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nota de Débito {{ debit_note.secuencial_display }}</title>
    <style>
        @page {
            size: A4;
            margin: 1cm;
        }
        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 10px;
            color: #000;
            line-height: 1.3;
        }
        .header-table {
            width: 100%;
            margin-bottom: 10px;
            border-collapse: collapse;
        }
        .company-info {
            width: 48%;
            vertical-align: top;
        }
        .document-info {
            width: 48%;
            vertical-align: top;
            border: 1px solid #000;
            border-radius: 8px;
            padding: 10px;
        }
        .box {
            border: 1px solid #000;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
        }
        .title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .label {
            font-weight: bold;
        }
        .access-key {
            font-family: "Courier New", monospace;
            font-size: 11px;
            letter-spacing: 1px;
        }
        .barcode {
            text-align: center;
            margin-top: 5px;
        }
        table.details {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table.details th, table.details td {
            border: 1px solid #000;
            padding: 4px;
        }
        table.details th {
            background-color: #f0f0f0;
            text-align: center;
            font-weight: bold;
        }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .totals-table {
            width: 40%;
            margin-left: auto;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .totals-table td {
            border: 1px solid #000;
            padding: 4px;
        }
        .logo-img {
            max-width: 250px;
            max-height: 100px;
            margin-bottom: 10px;
        }
        .additional-info {
            width: 55%;
            margin-top: 10px;
            border: 1px solid #000;
            padding: 5px;
        }
    </style>
</head>
<body>

    <table class="header-table">
        <tr>
            <td class="company-info">
                {% if debit_note.empresa.logo %}
                    <img src="{{ debit_note.empresa.logo.path }}" class="logo-img" alt="Logo">
                {% endif %}
                
                <div class="box">
                    <div class="title">{{ debit_note.empresa.razon_social }}</div>
                    {% if debit_note.empresa.nombre_comercial %}
                        <div>{{ debit_note.empresa.nombre_comercial }}</div>
                    {% endif %}
                    <br>
                    <div><span class="label">Dirección Matriz:</span> {{ debit_note.empresa.direccion_matriz|default:"-" }}</div>
                    <div><span class="label">Dirección Sucursal:</span> {{ debit_note.establecimiento.direccion|default:debit_note.empresa.direccion_matriz }}</div>
                    <br>
                    <div><span class="label">Contribuyente Especial Nro:</span> {{ debit_note.empresa.contribuyente_especial|default:"" }}</div>
                    <div><span class="label">OBLIGADO A LLEVAR CONTABILIDAD:</span> {{ debit_note.empresa.obligado_contabilidad|yesno:"SI,NO"|upper }}</div>
                    <br>
                    <div><span class="label">Teléfono:</span> {{ debit_note.empresa.telefono|default:"" }}</div>
                    <div><span class="label">Email:</span> {{ debit_note.empresa.email_contacto|default:debit_note.empresa.email_from|default:"" }}</div>
                </div>
            </td>
            
            <td style="width: 4%;"></td>

            <td class="document-info">
                <div><span class="label">R.U.C.:</span> {{ debit_note.empresa.ruc }}</div>
                <div class="title" style="margin-top: 5px;">NOTA DE DÉBITO</div>
                <div class="title">No. {{ debit_note.secuencial_display }}</div>
                
                <br>
                <div><span class="label">NÚMERO DE AUTORIZACIÓN:</span></div>
                <div class="access-key">{{ debit_note.numero_autorizacion|default:"PENDIENTE" }}</div>
                
                <br>
                <div>
                    <span class="label">FECHA Y HORA DE AUTORIZACIÓN:</span><br>
                    {{ debit_note.fecha_autorizacion|date:"d/m/Y H:i" }}
                </div>
                
                <br>
                <div><span class="label">AMBIENTE:</span> {{ debit_note.empresa.get_ambiente_display|upper }}</div>
                <div><span class="label">EMISIÓN:</span> NORMAL</div>
                
                <br>
                <div><span class="label">CLAVE DE ACCESO:</span></div>
                <div class="access-key">{{ debit_note.clave_acceso }}</div>
                
                {% if barcode_base64 %}
                <div class="barcode">
                    <img src="data:image/png;base64,{{ barcode_base64 }}" style="width: 90%; height: 35px;">
                </div>
                {% endif %}
            </td>
        </tr>
    </table>

    <div class="box">
        <table style="width: 100%;">
            <tr>
                <td><span class="label">Razón Social / Nombres y Apellidos:</span> {{ debit_note.razon_social_comprador }}</td>
                <td><span class="label">Identificación:</span> {{ debit_note.identificacion_comprador }}</td>
            </tr>
            <tr>
                <td><span class="label">Fecha Emisión:</span> {{ debit_note.fecha_emision|date:"d/m/Y" }}</td>
                <td></td>
            </tr>
            <tr>
                <td colspan="2" style="border-top: 1px dashed #ccc; padding-top: 5px; margin-top: 5px;">
                    <span class="label">Comprobante que se modifica:</span>
                    {# Lógica simple para mostrar tipo documento #}
                    {% if debit_note.cod_doc_modificado == '01' %}FACTURA{% else %}COMPROBANTE{% endif %}
                    : {{ debit_note.num_doc_modificado }}
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <span class="label">Fecha Emisión (Comprobante modificado):</span> 
                    {{ debit_note.fecha_emision_doc_sustento|date:"d/m/Y" }}
                </td>
            </tr>
        </table>
    </div>

    <table class="details">
        <thead>
            <tr>
                <th>RAZÓN DE LA MODIFICACIÓN</th>
                <th style="width: 15%;">VALOR DE LA MODIFICACIÓN</th>
            </tr>
        </thead>
        <tbody>
            {# Se usa 'with' y '.all' para iterar el RelatedManager de forma segura #}
            {% with motivos=debit_note.motivos.all %}
                {% if motivos %}
                    {# Caso 1: Motivos explícitos (Modelo DebitNoteMotivo) #}
                    {% for motivo in motivos %}
                    <tr>
                        <td>{{ motivo.razon }}</td>
                        <td class="text-right">{{ motivo.valor|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    {# Caso 2: Fallback a líneas de items (si existen) #}
                    {% for line in debit_note.lines.all %}
                    <tr>
                        <td>{{ line.descripcion }}</td>
                        <td class="text-right">{{ line.precio_total_sin_impuesto|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    {# Caso 3: Fallback a motivo general de la cabecera #}
                    <tr>
                        <td>{{ debit_note.motivo|default:"Ajuste de valor" }}</td>
                        <td class="text-right">{{ debit_note.total_sin_impuestos|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </tbody>
    </table>

    <div style="display: flex; margin-top: 10px;">
        <div class="additional-info">
            <div class="label" style="border-bottom: 1px solid #000; margin-bottom: 5px;">INFORMACIÓN ADICIONAL</div>
            
            {% if debit_note.direccion_comprador %}
                <div><span class="label">Dirección:</span> {{ debit_note.direccion_comprador }}</div>
            {% endif %}
            
            {% if debit_note.email_comprador %}
                <div><span class="label">Email:</span> {{ debit_note.email_comprador }}</div>
            {% endif %}

            {% if debit_note.observacion %}
                <div><span class="label">Observación:</span> {{ debit_note.observacion }}</div>
            {% endif %}
        </div>

        <table class="totals-table">
            <tr>
                <td class="label">SUBTOTAL SIN IMPUESTOS</td>
                <td class="text-right">{{ debit_note.total_sin_impuestos|default:"0.00"|floatformat:2 }}</td>
            </tr>
            
            {# Iterar impuestos reales asociados #}
            {% for imp in debit_note.impuestos.all %}
            <tr>
                <td class="label">
                    {% if imp.codigo_porcentaje == "0" %}SUBTOTAL 0%
                    {% elif imp.codigo_porcentaje == "2" %}SUBTOTAL 12%
                    {% elif imp.codigo_porcentaje == "3" %}SUBTOTAL 14%
                    {% elif imp.codigo_porcentaje == "4" %}SUBTOTAL 15%
                    {% else %}IVA {{ imp.tarifa }}%{% endif %}
                </td>
                <td class="text-right">{{ imp.base_imponible|floatformat:2 }}</td>
            </tr>
            {% empty %}
                {# Si no hay impuestos detallados, mostramos el total IVA si existe #}
                {% if debit_note.total_impuestos > 0 %}
                <tr>
                    <td class="label">VALOR IVA</td>
                    <td class="text-right">{{ debit_note.total_impuestos|floatformat:2 }}</td>
                </tr>
                {% endif %}
            {% endfor %}

            {# Mostrar el total de impuestos agrupado al final si se desea, o solo el desglose arriba #}
            {% if debit_note.total_impuestos > 0 %}
            <tr>
                <td class="label">TOTAL IMPUESTOS</td>
                <td class="text-right">{{ debit_note.total_impuestos|default:"0.00"|floatformat:2 }}</td>
            </tr>
            {% endif %}

            <tr>
                <td class="label">VALOR TOTAL</td>
                <td class="text-right"><strong>{{ debit_note.valor_total|default:"0.00"|floatformat:2 }}</strong></td>
            </tr>
        </table>
    </div>

</body>
</html>