# ==================================================================
# CONFIGURACIÓN OBLIGATORIA JL ELECTRONIC S.A.S. - PASSENGER
# (Configurado para el entorno de producción en cPanel)
# ==================================================================
# DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION BEGIN
PassengerAppRoot "/home/nexosdel/jlelectronic.nexosdelecuador.com"
PassengerBaseURI "/"
PassengerPython "/home/nexosdel/virtualenv/jlelectronic.nexosdelecuador.com/3.11/bin/python"
# DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION END

# --- Activar Passenger ---
PassengerEnabled on

# ==================================================================
# OPTIMIZACIÓN ESTÁTICOS Y SEGURIDAD (Blindaje Fase 1.5)
# ==================================================================

# --- Opciones seguras/minimalistas ---
Options -MultiViews -Indexes
DirectoryIndex index.html

# --- ENTREGAR ESTÁTICOS DIRECTO (Bypass total de Python) ---
# Optimizado para los assets generados por tu 'yarn build'
<FilesMatch "\.(?:html|js|mjs|css|png|jpg|jpeg|gif|webp|svg|ico|json|webmanifest|txt|map|woff2?|ttf|eot|otf)$">
    SetHandler none
    Require all granted
</FilesMatch>

# --- LiteSpeed: Desactiva ESI/Cache para evitar corrupción de JSON/React ---
<IfModule LiteSpeed>
    ESIEnable off
    CacheDisable public
    CacheLookup public off
</IfModule>

# --- ModSecurity: Apagar para evitar bloqueos en API POST del SRI ---
<IfModule mod_security.c>
    SecFilterEngine Off
    SecFilterScanPOST Off
</IfModule>
<IfModule mod_security2.c>
    SecRuleEngine Off
</IfModule>

# --- Compresión: Evitar doble compresión en binarios ---
<IfModule mod_deflate.c>
    SetEnvIfNoCase Request_URI "\.(?:jpg|jpeg|png|gif|webp|ico|svg|woff2?|ttf|eot|otf|map)$" no-gzip=1
</IfModule>
<IfModule mod_brotli.c>
    SetEnvIfNoCase Request_URI "\.(?:jpg|jpeg|png|gif|webp|ico|svg|woff2?|ttf|eot|otf|map)$" no-brotli=1
</IfModule>

# --- Tipos MIME correctos (Requerido para PWA de JL Electronic) ---
<IfModule mod_mime.c>
    AddType application/manifest+json .webmanifest
    AddType application/json             .json
    AddType application/javascript       .js
    AddType text/javascript              .mjs
    AddType image/svg+xml                .svg
    AddType font/woff2                   .woff2
</IfModule>

# --- Cabeceras de seguridad básicas ---
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
</IfModule>

# ==================================================================
# ENRUTAMIENTO (REWRITE ENGINE)
# ==================================================================
<IfModule mod_rewrite.c>
    RewriteEngine On

    # 1. Forzar HTTPS (Requerido para transmisión SRI 2026)
    RewriteCond %{HTTPS} !=on
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301,NE]

    # 2. Si el archivo existe físicamente en el build de React, sírvelo.
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # 3. Rutas explícitas de estáticos/media de Django
    RewriteRule ^(static/|media/) - [L]

    # 4. SPA Routing: Redirigir todo al index.html del frontend
    # Excepto las llamadas a la API o al Admin de Django
    RewriteCond %{REQUEST_URI} !^/(api|admin)
    RewriteRule ^ /index.html [L]

    # 5. Todo lo demás (API/Admin) se pasa a Passenger/Django
    RewriteRule . - [L]
</IfModule>